# 图片传输协议

## 帧格式（16位序号）


| 帧头1 | 帧头2 | 序号高8位 | 序号低8位 | 长度高8位 | 长度低8位 | 数据（0~65535字节） | CRC16高8位 | CRC16低8位 |
|--------|--------|----------|--------|----------|---------|-----------------|-----------|----------|
| 0xAA   | 0x55   | 1字节    | 1字节    | 1字节    | 1字节    |                 | 1字节     | 1字节     |

- **帧头**：固定为 `0xAA 0x55`。
- **序号**：16位无符号整数，从0开始递增，用于检测丢包和重传。结束帧序号固定为 `0xFFFF`。
- **长度**：16位整数，表示数据的字节数。
- **数据**：实际传输的二进制数据。
- **CRC16**：对序号、长度和数据三个字段进行CRC16校验（多项式 `0x8005`，初始值 `0xFFFF`）。

## 传输过程
1. **发送方**：
   - 打开文件，按固定块大小（如1024字节）读取数据。
   - 为每个数据块构建帧并发送。
   - 发送后等待接收方确认：
     - 收到 `ACK`（`0x06`）则发送下一块。
     - 收到 `NAK`（`0x15`）或超时则重传当前块（最多重试3次）。
   - 所有数据发送完毕后，发送一个结束帧（序号 `0xFFFF`，长度0，CRC正确）。
2. **接收方**：
   - 等待帧头 `0xAA 0x55`。
   - 读取后续字段，校验CRC。
   - 若校验通过且序号正确，将数据写入文件，并回复 `ACK`。
   - 若校验失败或序号错误，回复 `NAK` 请求重传。
   - 收到结束帧后关闭文件，完成传输。
